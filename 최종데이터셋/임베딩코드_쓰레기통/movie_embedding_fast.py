# ì˜í™” Overview í…ìŠ¤íŠ¸ ì„ë² ë”© ìƒì„± (ë¹ ë¥¸ ë²„ì „)
import pandas as pd
import numpy as np
from sentence_transformers import SentenceTransformer
from tqdm import tqdm
import os

print("="*70)
print("ì˜í™” Overview í…ìŠ¤íŠ¸ ì„ë² ë”© ìƒì„± (ë¹ ë¥¸ ë²„ì „)")
print("="*70)

# ============================================================
# 1. ë°ì´í„° ë¡œë“œ
# ============================================================
print("\n[1/7] ë°ì´í„° ë¡œë”© ì¤‘...")
movie_main = pd.read_parquet("ìµœì¢…ë°ì´í„°ì…‹_ì˜í™”/00_movie_main.parquet")
print(f"      ì´ {len(movie_main):,}ê°œì˜ ì˜í™”")

# ============================================================
# 2. ëª¨ë¸ ë¡œë“œ - ë” ì‘ì€ ëª¨ë¸ ì‚¬ìš©! (90MBë§Œ ë‹¤ìš´ë¡œë“œ)
# ============================================================
print("\n[2/7] Sentence Transformer ëª¨ë¸ ë¡œë”© ì¤‘...")
print("      âš¡ ë¹ ë¥¸ ë‹¤ìš´ë¡œë“œë¥¼ ìœ„í•´ ì‘ì€ ëª¨ë¸ ì‚¬ìš©")
print("      ëª¨ë¸: paraphrase-MiniLM-L6-v2 (90MB, 384ì°¨ì›)")
print("      ì°¸ê³ : ì›ë˜ ëª¨ë¸(438MB, 768ì°¨ì›)ë³´ë‹¤ í›¨ì”¬ ë¹ ë¥´ê²Œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤")

# ì‘ì€ ëª¨ë¸ ì‚¬ìš© (ë‹¤ìš´ë¡œë“œ ì‹œê°„ 1/5ë¡œ ë‹¨ì¶•!)
model = SentenceTransformer('sentence-transformers/paraphrase-MiniLM-L6-v2')
print(f"      âœ“ ëª¨ë¸ ë¡œë“œ ì™„ë£Œ! (device: {model.device})")

# ============================================================
# 3. í…ìŠ¤íŠ¸ ì¤€ë¹„
# ============================================================
print("\n[3/7] í…ìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„ ì¤‘...")
texts = movie_main['overview'].fillna("").tolist()
print(f"      {len(texts):,}ê°œì˜ overview ì¤€ë¹„ ì™„ë£Œ")

# ============================================================
# 4. ì„ë² ë”© ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬)
# ============================================================
print("\n[4/7] ì„ë² ë”© ìƒì„± ì¤‘...")
print("      ë°°ì¹˜ í¬ê¸°: 32")
print("      ì‘ì€ ëª¨ë¸ì´ë¼ ë” ë¹ ë¦…ë‹ˆë‹¤! ğŸš€")

batch_size = 32

embeddings = model.encode(
    texts,
    batch_size=batch_size,
    show_progress_bar=True,
    convert_to_numpy=True
)

print(f"\n      âœ“ ì„ë² ë”© ìƒì„± ì™„ë£Œ!")
print(f"      Shape: {embeddings.shape}")
print(f"      ì°¨ì›: {embeddings.shape[1]}D (384ì°¨ì›)")

# ============================================================
# 5. ë°ì´í„°í”„ë ˆì„ì— ì¶”ê°€
# ============================================================
print("\n[5/7] ë°ì´í„°í”„ë ˆì„ì— ì„ë² ë”© ì¶”ê°€ ì¤‘...")
movie_main['embedding'] = list(embeddings)
print(f"      âœ“ ì™„ë£Œ!")

# ============================================================
# 6. ì¤‘ê°„ ê²°ê³¼ CSV ì €ì¥
# ============================================================
print("\n[6/7] ì¤‘ê°„ ê²°ê³¼ CSV ì €ì¥ ì¤‘...")
csv_path = "movie_embeddings_progress.csv"
movie_main.to_csv(csv_path, index=False)
csv_size = os.path.getsize(csv_path) / (1024*1024)
print(f"      âœ“ ì €ì¥ ì™„ë£Œ: {csv_path}")
print(f"      í¬ê¸°: {csv_size:.2f} MB")

# ============================================================
# 7. ìµœì¢… ê²°ê³¼ Parquet ì €ì¥
# ============================================================
print("\n[7/7] ìµœì¢… ê²°ê³¼ Parquet ì €ì¥ ì¤‘...")
parquet_path = "movie_with_embeddings.parquet"
movie_main.to_parquet(parquet_path, index=False)
parquet_size = os.path.getsize(parquet_path) / (1024*1024)
print(f"      âœ“ ì €ì¥ ì™„ë£Œ: {parquet_path}")
print(f"      í¬ê¸°: {parquet_size:.2f} MB")

# ============================================================
# ê²°ê³¼ ìš”ì•½
# ============================================================
print("\n" + "="*70)
print("ì‘ì—… ì™„ë£Œ! ğŸ‰")
print("="*70)

print(f"""
ğŸ“Š ê²°ê³¼ ìš”ì•½:
  â€¢ ì²˜ë¦¬ëœ ì˜í™”: {len(movie_main):,}ê°œ
  â€¢ ëª¨ë¸: paraphrase-MiniLM-L6-v2 (ë¹ ë¥¸ ë²„ì „)
  â€¢ ì„ë² ë”© ì°¨ì›: {embeddings.shape[1]}D
  â€¢ CSV íŒŒì¼: {csv_path} ({csv_size:.2f} MB)
  â€¢ Parquet íŒŒì¼: {parquet_path} ({parquet_size:.2f} MB)

ğŸ’¡ ì°¸ê³ :
  ì´ ëª¨ë¸(384ì°¨ì›)ì€ ì›ë˜ ëª¨ë¸(768ì°¨ì›)ë³´ë‹¤:
  â€¢ ë‹¤ìš´ë¡œë“œ 5ë°° ë¹ ë¦„ âš¡
  â€¢ ì²˜ë¦¬ ì†ë„ 2ë°° ë¹ ë¦„ ğŸš€
  â€¢ ì„±ëŠ¥ì€ ì•½ 95% ìˆ˜ì¤€ âœ…
  â€¢ ëŒ€ë¶€ë¶„ì˜ ìš©ë„ì— ì¶©ë¶„í•©ë‹ˆë‹¤!

ğŸ“ ì¶œë ¥ íŒŒì¼:
  1. {csv_path} - ì¤‘ê°„ ê²°ê³¼
  2. {parquet_path} - ìµœì¢… ê²°ê³¼ (ì••ì¶•)

âœ… ì„ë² ë”© í†µê³„:
  â€¢ í‰ê· : {embeddings.mean():.6f}
  â€¢ í‘œì¤€í¸ì°¨: {embeddings.std():.6f}
  â€¢ ìµœì†Œê°’: {embeddings.min():.6f}
  â€¢ ìµœëŒ€ê°’: {embeddings.max():.6f}
""")

print("="*70)
print("ì´ì œ ìœ ì‚¬ë„ ë¶„ì„, í´ëŸ¬ìŠ¤í„°ë§, ê²€ìƒ‰ ì‹œìŠ¤í…œ êµ¬ì¶•ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!")
print("="*70)
